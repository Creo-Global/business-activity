<script type="module">

  (function() {
    'use strict';
  
    // ─── Configuration ─────────────────────────────────────────────
    const PER_PAGE = 9;
    const SUPABASE_URL = 'https://sb.meydanfz.ae';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNzU3MjQyMDM2LCJleHAiOjIwNzI4MTgwMzZ9.5YF79Wen41bSpKNOKiT9Wcd_psXf8IV4vgK7RUjOZoI';
  
    // ─── State Management ──────────────────────────────────────────
    // Centralized state for the component
    const state = {
      currentPage: 1,
      currentCategory: '',
      searchTerm: '',
    };
  
    // ─── Supabase Client & Cache ───────────────────────────────────
    // Note: Using a dynamic import for the Supabase client.
    let supabase;
    const cache = {
      data: {},
      set: function(key, data, count) {
        this.data[key] = { data, count, timestamp: Date.now() };
      },
      get: function(key) {
        const entry = this.data[key];
        if (!entry) return null;
        // Cache expires after 5 minutes
        if (Date.now() - entry.timestamp > 5 * 60 * 1000) {
          delete this.data[key];
          return null;
        }
        return entry;
      },
      clear: function() {
        this.data = {};
      }
    };
  
    // ─── DOM Element References ────────────────────────────────────
    // Grouping all DOM selectors for easy management.
    const dom = {
      tplEl: document.querySelector('.activity-card-template'),
      listEl: document.getElementById('activities-container'),
      categoryContainers: document.querySelectorAll('.js-category-filter-container'),
      searchEl: document.getElementById('search-input'),
      pagerEl: document.getElementById('pagination-container'),
      activeGroupSpan: document.querySelector('.active-group'),
    };
  
        // ─── Utility Functions ─────────────────────────────────────────

    function createLoader() {
      const loaderContainer = document.createElement('div');
      loaderContainer.className = 'loader-container';
      loaderContainer.style.cssText = 'display:flex; justify-content:center; align-items:center; width:100%; padding:40px 0;';
      const loader = document.createElement('div');
      loader.className = 'loader';
      loader.style.cssText = 'border:5px solid rgba(5,102,51,0.2); border-top-color:#056633; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite;';
      const style = document.createElement('style');
      style.textContent = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
      document.head.appendChild(style);
      loaderContainer.appendChild(loader);
      return loaderContainer;
    }

    function closeAccordionOnMobile() {
      // Only close accordion on iPad and smaller devices (768px and below)
      if (window.innerWidth > 820) return;
      
      const accordionWrapper = document.querySelector('.f-accordian-wrapper.activity');
      if (!accordionWrapper) return;
      
      const dropdown = accordionWrapper.querySelector('.f-accordian-dropdown');
      const toggle = accordionWrapper.querySelector('.f-accordian-toggle');
      const list = accordionWrapper.querySelector('.f-accordian-list');
      const icon = accordionWrapper.querySelector('.f-accordian-icon');
      
      if (!dropdown || !toggle || !list) return;
      
      // Get current height before starting animation
      const currentHeight = list.scrollHeight;
      
      // Ensure list has transition for smooth animation
      list.style.transition = 'height 0.3s ease, opacity 0.3s ease';
      list.style.overflow = 'hidden';
      
      // Set initial height to current height to enable transition
      list.style.height = currentHeight + 'px';
      
      // Force a reflow to ensure the height is set
      list.offsetHeight;
      
      // Start the closing animation
      requestAnimationFrame(() => {
        // Animate list closing
        list.style.height = '0px';
        list.style.opacity = '0.5';
        
        // Animate icon rotation with smooth transition
        if (icon) {
          icon.style.transition = 'transform 0.3s ease, color 0.3s ease';
          icon.style.transform = 'translate3d(0px, 0px, 0px) scale3d(1, 1, 1) rotateX(0deg) rotateY(0deg) rotateZ(0deg) skew(0deg, 0deg)';
          icon.style.color = 'rgb(107, 112, 148)'; // Reset to closed state color
        }
      });
      
      // After animation completes, clean up classes and attributes
      setTimeout(() => {
        dropdown.classList.remove('w--open');
        toggle.classList.remove('w--open');
        list.classList.remove('w--open');
        
        // Update ARIA attributes
        toggle.setAttribute('aria-expanded', 'false');
        
        // Reset opacity and remove transition to match Webflow behavior
        list.style.opacity = '';
        list.style.transition = '';
        list.style.overflow = '';
      }, 300); // Match transition duration
    }
  
    function showLoader() {
      const existingLoader = dom.listEl.querySelector('.loader-container');
      if (existingLoader) existingLoader.remove();
      dom.listEl.innerHTML = '';
      dom.listEl.appendChild(createLoader());
    }
  
    function hideLoader() {
      const loader = dom.listEl.querySelector('.loader-container');
      if (loader) loader.remove();
    }
  
    function updateActiveGroupDisplay() {
      if (dom.activeGroupSpan) {
        const displayText = state.currentCategory || 'All Categories';
        dom.activeGroupSpan.textContent = displayText;
      }
    }

    function updateAccordionTitle() {
      const accordionTitle = document.querySelector('.f-accordian-title');
      if (accordionTitle) {
        const displayText = state.currentCategory || 'All Categories';
        accordionTitle.textContent = displayText;
      }
    }
  
    // ─── Modal Logic ───────────────────────────────────────────────
  
    function showModalWithData(activityData, modalEl) {
      const modalFieldMapping = {
        'code': activityData.Code, 'group': activityData.Group, 'name': activityData['Activity Name'],
        'arabic': activityData['النشاط'], 'risk': activityData['Risk Rating'] || 'N/A', 'industry': activityData['Industry Risk'] || 'N/A',
        'thirdparty': activityData['Third Party'] || 'N/A', 'when': activityData.When || 'N/A', 'notes': activityData.Notes || 'N/A',
        'dnfbp': activityData.DNFBP || 'N/A'
      };
      Object.entries(modalFieldMapping).forEach(([key, value]) => {
        const element = modalEl.querySelector(`[data-${key}]`);
        if (element) element.textContent = value;
      });
    }
  
    function showModal(modalWrapper) {
      if (!modalWrapper) return;
      modalWrapper.style.display = 'flex';
      const modal = modalWrapper.querySelector('.modal.ba');
      if (modal) {
        setTimeout(() => {
          modal.style.opacity = '1';
          if (window.innerWidth < 740) modal.style.marginTop = '0px';
        }, 10);
      }
    }
  
    function hideModal(modalWrapper) {
      if (!modalWrapper) return;
      const modal = modalWrapper.querySelector('.modal.ba');
      if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => { modalWrapper.style.display = 'none'; }, 300);
      } else {
        modalWrapper.style.display = 'none';
      }
    }
  
    function setupModalCloseButtons(modalWrapper) {
      if (!modalWrapper) return;
      modalWrapper.querySelectorAll('.modal-close, .modal-close-icon').forEach(button => {
        button.addEventListener('click', () => hideModal(modalWrapper));
      });
      modalWrapper.addEventListener('click', (event) => {
        if (event.target === modalWrapper) hideModal(modalWrapper);
      });
    }
  
    // ─── Category Filtering Logic (Refactored) ─────────────────────
  
    async function initCategoryRadios() {
      try {
        const { data, error } = await supabase.from('Activity List').select('Category');
        if (error) {
          return;
        }
  
        const dbCategories = Array.from(new Set(data.map(r => r.Category).filter(Boolean))).sort();
        
        dom.categoryContainers.forEach((container, index) => {
          populateCategoryContainer(container, dbCategories, index);
        });
        
        setupCategoryEventListeners();
        
      } catch (error) {
      }
    }
  
    function populateCategoryContainer(container, categories, containerIndex) {
      const radioFields = Array.from(container.querySelectorAll('.radio_field'));
      if (radioFields.length === 0) return;
  
      // "All Categories" option
      const firstField = radioFields[0];
      const firstRadio = firstField.querySelector('.radio_button, input[type="radio"]');
      const firstLabel = firstField.querySelector('.radio_label, label');
      if (firstRadio && firstLabel) {
        const allId = `filter-${containerIndex}-category-all`;
        firstRadio.id = allId;
        firstLabel.htmlFor = allId;
        firstLabel.textContent = 'All Categories';
        firstField.dataset.category = ''; // Use data-attribute for the value
        firstField.style.display = 'block';
      }
      
      // Other categories
      radioFields.forEach((field, index) => {
        if (index === 0) return; // Skip "All"
        const radioButton = field.querySelector('.radio_button, input[type="radio"]');
        const radioLabel = field.querySelector('.radio_label, label');
        if (!radioButton || !radioLabel) return;
        
        const categoryIndex = index - 1;
        if (categoryIndex < categories.length) {
          const category = categories[categoryIndex];
          const radioId = `filter-${containerIndex}-category-${index}`;
          radioButton.id = radioId;
          radioLabel.htmlFor = radioId;
          radioLabel.textContent = category;
          field.dataset.category = category;
          field.style.display = 'block';
        } else {
          field.style.display = 'none';
        }
      });
    }
  
    function setupCategoryEventListeners() {
      dom.categoryContainers.forEach(container => {
        container.addEventListener('click', (event) => {
          const field = event.target.closest('.radio_field');
          if (field && typeof field.dataset.category !== 'undefined') {
            handleCategoryChange(field.dataset.category);
          }
        });
      });
    }
  
    function handleCategoryChange(newCategory) {
      if (state.currentCategory === newCategory) return;
      
      state.currentCategory = newCategory;
      
      syncCategoryRadios(state.currentCategory);
      updateCurrentCategoryClass();
      updateActiveGroupDisplay();
      updateAccordionTitle();
      
      // Close accordion on mobile devices when category is selected
      closeAccordionOnMobile();
      
      state.currentPage = 1;
      renderPage(1);
    }
  
    function syncCategoryRadios(newCategory) {
      dom.categoryContainers.forEach(container => {
        const fields = container.querySelectorAll('.radio_field');
        fields.forEach(field => {
          const radio = field.querySelector('input[type="radio"]');
          if (radio) {
            radio.checked = (field.dataset.category === newCategory);
          }
        });
      });
    }
  
    function updateCurrentCategoryClass() {
      dom.categoryContainers.forEach(container => {
        container.querySelectorAll('.radio_field').forEach(field => {
          if (field.dataset.category === state.currentCategory) {
            field.classList.add('current');
          } else {
            field.classList.remove('current');
          }
        });
      });
    }
  
    // ─── Data Fetching & Rendering ──────────────────────────────────
  
    async function renderPage(page = 1) {
      showLoader();
      state.currentPage = page;
      const { currentCategory, searchTerm } = state;
  
      const cacheKey = `${currentCategory}|${searchTerm}|${page}`;
      
      const cachedResult = cache.get(cacheKey);
      if (cachedResult) {
        renderResults(cachedResult.data, page, cachedResult.count);
        return;
      }
  
      let query = supabase.from('Activity List').select('*', { count: 'exact' });
  
      if (currentCategory) {
        query = query.eq('Category', currentCategory);
      }
      if (searchTerm) {
        query = query.or(`"Activity Name".ilike.%${searchTerm}%,Code.ilike.%${searchTerm}%,النشاط.ilike.%${searchTerm}%`);
      }
  
      const from = (page - 1) * PER_PAGE;
      const to = from + PER_PAGE - 1;
      query = query.order('Code', { ascending: true }).range(from, to);
  
      const { data, error, count } = await query;
      
      if (error) {
        hideLoader();
        dom.listEl.innerHTML = '<p>Error loading data. Please try again.</p>';
        return;
      }
      
      cache.set(cacheKey, data, count);
      renderResults(data, page, count);
    }
  
    function renderResults(data, page, count) {
      hideLoader();
      dom.listEl.innerHTML = '';
  
      if (data?.length > 0) {
        data.forEach(item => {
          const clone = dom.tplEl.cloneNode(true);
          clone.classList.remove('activity-card-template', 'hide');
          clone.style.display = 'flex';
  
          const fieldMapping = {
            'code': item.Code, 'group': item.Group, 'category': item.Category,
            'name': item['Activity Name'], 'arabic': item['النشاط'], 'risk': item['Risk Rating'],
            'industry': item['Industry Risk'], 'thirdparty': item['Third Party'], 'when': item.When,
            'notes': item.Notes, 'dnfbp': item.DNFBP
          };
  
          Object.entries(fieldMapping).forEach(([key, value]) => {
            const element = clone.querySelector(`[data-${key}]`);
            if (element) element.textContent = value || '';
          });
  
          const modalWrapper = clone.querySelector('.modal-wrapper.ba');
          if (modalWrapper) {
            showModalWithData(item, modalWrapper);
            setupModalCloseButtons(modalWrapper);
            modalWrapper.style.display = 'none';
            const modal = modalWrapper.querySelector('.modal.ba');
            if (modal) modal.style.opacity = '0';
          }
          
          clone.style.cursor = 'pointer';
          clone.addEventListener('click', (event) => {
            event.stopPropagation();
            if (modalWrapper) showModal(modalWrapper);
          });
  
          dom.listEl.appendChild(clone);
        });
      } else {
        dom.listEl.innerHTML = '<p>No activities found matching your criteria.</p>';
      }
  
      state.currentPage = page;
      renderPagination(page, count);
    }
  
    // ─── Pagination Logic ──────────────────────────────────────────
  
    function renderPagination(currentPageNum, totalCount) {
      const totalPages = Math.ceil((totalCount || 0) / PER_PAGE) || 1;
      dom.pagerEl.innerHTML = '';
      if (totalPages <= 1) return;
  
      const paginationWrapper = document.createElement('div');
      paginationWrapper.className = 'pagination_page-wrapper';
      
      const createButton = (text, page, isDisabled, isCurrent, className) => {
        const button = document.createElement('button');
        button.textContent = text;
        button.disabled = isDisabled;
        button.className = className || '';
        if (isCurrent) button.classList.add('current-page');
        button.style.cssText = 'background-color:transparent; border:none; cursor:pointer;';
        if (!isDisabled) button.onclick = () => renderPage(page);
        return button;
      };
      
      paginationWrapper.appendChild(createButton('Previous', currentPageNum - 1, currentPageNum === 1, false, 'pagination_previous'));
  
      const pageRange = 2;
      const startPage = Math.max(1, currentPageNum - pageRange);
      const endPage = Math.min(totalPages, currentPageNum + pageRange);
  
      if (startPage > 1) {
        paginationWrapper.appendChild(createButton('1', 1, false, false, ''));
        if (startPage > 2) paginationWrapper.insertAdjacentHTML('beforeend', '<span>...</span>');
      }
  
      for (let page = startPage; page <= endPage; page++) {
        paginationWrapper.appendChild(createButton(page.toString(), page, false, page === currentPageNum, ''));
      }
  
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) paginationWrapper.insertAdjacentHTML('beforeend', '<span>...</span>');
        paginationWrapper.appendChild(createButton(totalPages.toString(), totalPages, false, false, ''));
      }
      
      paginationWrapper.appendChild(createButton('Next', currentPageNum + 1, currentPageNum === totalPages, false, 'pagination-next'));
      dom.pagerEl.appendChild(paginationWrapper);
    }
  
    // ─── Search Functionality ──────────────────────────────────────
  
    function setupSearch() {
      let searchTimeout;
      dom.searchEl.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          state.searchTerm = dom.searchEl.value.trim();
          state.currentPage = 1;
          renderPage(1);
        }, 300);
      });
  
      dom.searchEl.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
        }
      });
    }
  
    // ─── Initialization ────────────────────────────────────────────
  
    async function initialize() {
      try {
        // Dynamically import Supabase client
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
        // Validate DOM elements
        if (!dom.tplEl || !dom.listEl || dom.categoryContainers.length === 0 || !dom.searchEl || !dom.pagerEl) {
          return;
        }
  
        setupSearch();
        await initCategoryRadios();
        
        // Always default to 'All Categories' on page load, ignoring localStorage.
        state.currentCategory = '';
        
        // Sync both radio lists to match the initial default state.
        syncCategoryRadios(state.currentCategory);
        
        updateCurrentCategoryClass();
        updateActiveGroupDisplay();
        updateAccordionTitle();
        await renderPage(1);
        
      } catch (error) {
      }
    }
  
    // ─── Start on DOM ready ────────────────────────────────────────
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
  
  })();
  </script>